/**
 * Copyright (C) 2016 Michael Kourlas
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var error_1 = require("./error");
var request_1 = require("./request");
var utils_1 = require("./utils");
/**
 * @private
 */
var BASE_URL = "https://api.cloudflare.com/client/v4";
/**
 * Creates or updates a CloudFlare DNS record, depending on whether it already
 * exists. An error is returned if there are multiple DNS records for the
 * specified record name.
 *
 * @param auth CloudFlare API authentication information.
 * @param ip The IP to update the record with.
 * @param recordName The name of the record.
 * @param zoneName The name of the zone.
 * @param callback Callback function called with any error that occurred.
 *
 * @private
 */
function createOrUpdateDnsRecord(auth, ip, recordName, zoneName, callback) {
    getZoneId(zoneName, auth, function (error, zoneId) {
        if (error || !zoneId) {
            callback(error || new Error("Unknown error"));
            return;
        }
        getDnsRecordId(zoneId, recordName, auth, function (error2, dnsRecordId) {
            if (error2) {
                callback(error2);
                return;
            }
            if (dnsRecordId) {
                updateDnsRecord(zoneId, dnsRecordId, ip, auth, function (error3) {
                    callback(error3);
                });
            }
            else {
                createDnsRecord(zoneId, recordName, ip, auth, function (error3) {
                    callback(error3);
                });
            }
        });
    });
}
exports.createOrUpdateDnsRecord = createOrUpdateDnsRecord;
/**
 * Gets the specified DNS record from CloudFlare. This function is only used
 * for testing this module.
 *
 * @param auth CloudFlare API authentication information.
 * @param recordName The name of the record.
 * @param zoneName The name of the zone.
 * @param callback Callback function called with any error that occurred as
 *                 well as the ID of the record retrieved.
 *
 * @private
 */
function getDnsRecord(auth, recordName, zoneName, callback) {
    getZoneId(zoneName, auth, function (error, zoneId) {
        if (error || !zoneId) {
            callback(error || new Error("Unknown error"));
            return;
        }
        getDnsRecordId(zoneId, recordName, auth, function (error2, dnsRecordId) {
            if (error2) {
                callback(error2);
                return;
            }
            callback(undefined, dnsRecordId);
        });
    });
}
exports.getDnsRecord = getDnsRecord;
/**
 * Deletes the specified DNS record from CloudFlare. This function is only used
 * for testing this module.
 *
 * @param auth CloudFlare API authentication information.
 * @param recordName The name of the record.
 * @param zoneName The name of the zone.
 * @param callback Callback function called with any error that occurred.
 *
 * @private
 */
function deleteDnsRecord(auth, recordName, zoneName, callback) {
    getZoneId(zoneName, auth, function (error, zoneId) {
        if (error || !zoneId) {
            callback(error || new Error("Unknown error"));
            return;
        }
        getDnsRecordId(zoneId, recordName, auth, function (error2, dnsRecordId) {
            if (error2) {
                callback(error2);
                return;
            }
            if (dnsRecordId) {
                getResults("zones/" + zoneId + "/dns_records/" + dnsRecordId, auth, function (error3, results) {
                    if (error3 || !results) {
                        callback(error3 || new Error("Unknown error"));
                        return;
                    }
                    callback();
                }, "DELETE");
            }
            else {
                callback();
            }
        });
    });
}
exports.deleteDnsRecord = deleteDnsRecord;
/**
 * Creates a DNS record with the specified information.
 *
 * @param zoneId The zone ID.
 * @param dnsRecordName The DNS record name.
 * @param ip The IP to update the record with.
 * @param auth CloudFlare API authentication information.
 * @param callback Callback function called with any error that occurred.
 *
 * @private
 */
function createDnsRecord(zoneId, dnsRecordName, ip, auth, callback) {
    getResults("zones/" + zoneId + "/dns_records", auth, function (error, results) {
        if (error || !results) {
            callback(error || new Error("Unknown error"));
            return;
        }
        callback();
    }, "POST", JSON.stringify({
        content: ip,
        name: dnsRecordName,
        type: "A"
    }));
}
/**
 * Updates a DNS record with the specified information.
 *
 * @param zoneId The zone ID.
 * @param recordId The DNS record ID.
 * @param ip The IP to update the record with.
 * @param auth CloudFlare API authentication information.
 * @param callback Callback function called with any error that occurred.
 *
 * @private
 */
function updateDnsRecord(zoneId, recordId, ip, auth, callback) {
    getResults("zones/" + zoneId + "/dns_records/" + recordId, auth, function (error, results) {
        if (error || !results) {
            callback(error || new Error("Unknown error"));
            return;
        }
        callback();
    }, "PATCH", JSON.stringify({
        content: ip,
        type: "A"
    }));
}
/**
 * Gets the DNS record ID associated with the specified record name.
 *
 * @param zoneId The zone ID.
 * @param dnsRecordName The DNS record name.
 * @param auth CloudFlare API authentication information.
 * @param callback Callback function called with any error that occurred, as
 *                 well as the DNS record ID.
 *
 * @private
 */
function getDnsRecordId(zoneId, dnsRecordName, auth, callback) {
    getResults("zones/" + zoneId + "/dns_records", auth, function (error, results) {
        if (error || !results) {
            callback(error || new Error("Unknown error"));
            return;
        }
        var matchingResults = results.filter(function (result) { return result.name === dnsRecordName; });
        if (matchingResults.length === 0) {
            callback();
            return;
        }
        if (matchingResults.length > 1) {
            callback(new error_1.ApiError({
                message: "Multiple DNS record entries found with name"
                    + (" " + dnsRecordName),
                result: results
            }));
            return;
        }
        var result = matchingResults[0];
        if (!utils_1.isString(result.id)) {
            callback(new error_1.ApiError({
                message: "ID for DNS record entry malformed or missing",
                result: results
            }));
            return;
        }
        callback(undefined, result.id);
    });
}
exports.getDnsRecordId = getDnsRecordId;
/**
 * Gets the zone ID associated with the specified zone name.
 *
 * @param zoneName The zone name.
 * @param auth CloudFlare API authentication information.
 * @param callback Callback function called with any error that occurred, as
 *                 well as the zone ID.
 *
 * @private
 */
function getZoneId(zoneName, auth, callback) {
    getResults("zones", auth, function (error, results) {
        if (error || !results) {
            callback(error || new Error("Unknown error"));
            return;
        }
        var matchingResults = results.filter(function (result) { return result.name === zoneName; });
        if (matchingResults.length === 0) {
            callback(new error_1.ApiError({
                message: "No zone entries found with name " + zoneName,
                result: results
            }));
            return;
        }
        if (matchingResults.length > 1) {
            callback(new error_1.ApiError({
                message: "No zone entries found with name " + zoneName,
                result: results
            }));
            return;
        }
        var result = results[0];
        if (!utils_1.isString(result.id)) {
            callback(new error_1.ApiError({
                message: "ID for zone entry malformed or missing",
                result: results
            }));
            return;
        }
        callback(undefined, result.id);
    });
}
exports.getZoneId = getZoneId;
/**
 * Gets results from the CloudFlare API.
 *
 * @param path The URI.
 * @param auth CloudFlare API authentication information.
 * @param callback Callback function called with any error that occurred, as
 *                 well as the API results.
 * @param method The HTTP method.
 * @param body The request body.
 * @param startPage The start page associated with the request.
 *
 * @private
 */
function getResults(path, auth, callback, method, body, startPage) {
    if (method === void 0) { method = "GET"; }
    if (startPage === void 0) { startPage = 1; }
    var uri = BASE_URL + "/" + path;
    if (method === "GET") {
        uri += "?page=" + startPage;
    }
    var headers = {
        "X-Auth-Key": auth.key,
        "X-Auth-Email": auth.email
    };
    request_1.httpsRequest(uri, function (error, response, responseBody) {
        if (error) {
            callback(new error_1.ApiError({
                body: responseBody,
                innerError: error,
                message: "Error accessing CloudFlare API",
                response: response
            }));
            return;
        }
        if (!responseBody) {
            callback(new error_1.ApiError({
                innerError: error,
                message: "Missing response body",
                response: response
            }));
            return;
        }
        var json = JSON.parse(responseBody);
        if (!json.success) {
            callback(new error_1.ApiError({
                body: responseBody,
                message: "CloudFlare API returned success false",
                response: response
            }));
            return;
        }
        var results = [];
        if (utils_1.isArray(json.result)) {
            results = results.concat(json.result);
        }
        else {
            results.push(json.result);
        }
        if (json.result_info
            && json.result_info.page
                < json.result_info.total_pages) {
            getResults(path, auth, function (extraError, extraResults) {
                if (error) {
                    callback(extraError);
                    return;
                }
                results = results.concat(extraResults);
                callback(undefined, results);
            }, method, body, startPage + 1);
        }
        else {
            callback(undefined, results);
        }
    }, method, headers, body);
}
exports.getResults = getResults;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUM7UUFDakMsQ0FBQztJQUNMLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzlCLENBQUM7QUFyRUQsZ0NBcUVDIiwiZmlsZSI6ImNsb3VkZmxhcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoQykgMjAxNiBNaWNoYWVsIEtvdXJsYXNcbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7QXBpRXJyb3J9IGZyb20gXCIuL2Vycm9yXCI7XG5pbXBvcnQge0F1dGh9IGZyb20gXCIuL29wdGlvbnNcIjtcbmltcG9ydCB7aHR0cHNSZXF1ZXN0fSBmcm9tIFwiLi9yZXF1ZXN0XCI7XG5pbXBvcnQge2lzQXJyYXksIGlzU3RyaW5nfSBmcm9tIFwiLi91dGlsc1wiO1xuXG4vKipcbiAqIEBwcml2YXRlXG4gKi9cbmNvbnN0IEJBU0VfVVJMID0gXCJodHRwczovL2FwaS5jbG91ZGZsYXJlLmNvbS9jbGllbnQvdjRcIjtcblxuLyoqXG4gKiBDcmVhdGVzIG9yIHVwZGF0ZXMgYSBDbG91ZEZsYXJlIEROUyByZWNvcmQsIGRlcGVuZGluZyBvbiB3aGV0aGVyIGl0IGFscmVhZHlcbiAqIGV4aXN0cy4gQW4gZXJyb3IgaXMgcmV0dXJuZWQgaWYgdGhlcmUgYXJlIG11bHRpcGxlIEROUyByZWNvcmRzIGZvciB0aGVcbiAqIHNwZWNpZmllZCByZWNvcmQgbmFtZS5cbiAqXG4gKiBAcGFyYW0gYXV0aCBDbG91ZEZsYXJlIEFQSSBhdXRoZW50aWNhdGlvbiBpbmZvcm1hdGlvbi5cbiAqIEBwYXJhbSBpcCBUaGUgSVAgdG8gdXBkYXRlIHRoZSByZWNvcmQgd2l0aC5cbiAqIEBwYXJhbSByZWNvcmROYW1lIFRoZSBuYW1lIG9mIHRoZSByZWNvcmQuXG4gKiBAcGFyYW0gem9uZU5hbWUgVGhlIG5hbWUgb2YgdGhlIHpvbmUuXG4gKiBAcGFyYW0gY2FsbGJhY2sgQ2FsbGJhY2sgZnVuY3Rpb24gY2FsbGVkIHdpdGggYW55IGVycm9yIHRoYXQgb2NjdXJyZWQuXG4gKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZU9yVXBkYXRlRG5zUmVjb3JkKGF1dGg6IEF1dGgsIGlwOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHpvbmVOYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IChlcnJvcj86IEVycm9yKSA9PiB2b2lkKTogdm9pZFxue1xuICAgIGdldFpvbmVJZCh6b25lTmFtZSwgYXV0aCwgKGVycm9yLCB6b25lSWQpID0+IHtcbiAgICAgICAgaWYgKGVycm9yIHx8ICF6b25lSWQpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yIHx8IG5ldyBFcnJvcihcIlVua25vd24gZXJyb3JcIikpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGdldERuc1JlY29yZElkKHpvbmVJZCwgcmVjb3JkTmFtZSwgYXV0aCwgKGVycm9yMiwgZG5zUmVjb3JkSWQpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnJvcjIpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvcjIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRuc1JlY29yZElkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlRG5zUmVjb3JkKHpvbmVJZCwgZG5zUmVjb3JkSWQsIGlwLCBhdXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZXJyb3IzPzogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yMyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjcmVhdGVEbnNSZWNvcmQoem9uZUlkLCByZWNvcmROYW1lLCBpcCwgYXV0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVycm9yMz86IEVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvcjMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbi8qKlxuICogR2V0cyB0aGUgc3BlY2lmaWVkIEROUyByZWNvcmQgZnJvbSBDbG91ZEZsYXJlLiBUaGlzIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZFxuICogZm9yIHRlc3RpbmcgdGhpcyBtb2R1bGUuXG4gKlxuICogQHBhcmFtIGF1dGggQ2xvdWRGbGFyZSBBUEkgYXV0aGVudGljYXRpb24gaW5mb3JtYXRpb24uXG4gKiBAcGFyYW0gcmVjb3JkTmFtZSBUaGUgbmFtZSBvZiB0aGUgcmVjb3JkLlxuICogQHBhcmFtIHpvbmVOYW1lIFRoZSBuYW1lIG9mIHRoZSB6b25lLlxuICogQHBhcmFtIGNhbGxiYWNrIENhbGxiYWNrIGZ1bmN0aW9uIGNhbGxlZCB3aXRoIGFueSBlcnJvciB0aGF0IG9jY3VycmVkIGFzXG4gKiAgICAgICAgICAgICAgICAgd2VsbCBhcyB0aGUgSUQgb2YgdGhlIHJlY29yZCByZXRyaWV2ZWQuXG4gKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldERuc1JlY29yZChhdXRoOiBBdXRoLCByZWNvcmROYW1lOiBzdHJpbmcsIHpvbmVOYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAoZXJyPzogRXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG5zUmVjb3JkSWQ/OiBzdHJpbmcpID0+IHZvaWQpOiB2b2lkXG57XG4gICAgZ2V0Wm9uZUlkKHpvbmVOYW1lLCBhdXRoLCAoZXJyb3IsIHpvbmVJZCkgPT4ge1xuICAgICAgICBpZiAoZXJyb3IgfHwgIXpvbmVJZCkge1xuICAgICAgICAgICAgY2FsbGJhY2soZXJyb3IgfHwgbmV3IEVycm9yKFwiVW5rbm93biBlcnJvclwiKSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZ2V0RG5zUmVjb3JkSWQoem9uZUlkLCByZWNvcmROYW1lLCBhdXRoLCAoZXJyb3IyLCBkbnNSZWNvcmRJZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycm9yMikge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yMik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCBkbnNSZWNvcmRJZCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG4vKipcbiAqIERlbGV0ZXMgdGhlIHNwZWNpZmllZCBETlMgcmVjb3JkIGZyb20gQ2xvdWRGbGFyZS4gVGhpcyBmdW5jdGlvbiBpcyBvbmx5IHVzZWRcbiAqIGZvciB0ZXN0aW5nIHRoaXMgbW9kdWxlLlxuICpcbiAqIEBwYXJhbSBhdXRoIENsb3VkRmxhcmUgQVBJIGF1dGhlbnRpY2F0aW9uIGluZm9ybWF0aW9uLlxuICogQHBhcmFtIHJlY29yZE5hbWUgVGhlIG5hbWUgb2YgdGhlIHJlY29yZC5cbiAqIEBwYXJhbSB6b25lTmFtZSBUaGUgbmFtZSBvZiB0aGUgem9uZS5cbiAqIEBwYXJhbSBjYWxsYmFjayBDYWxsYmFjayBmdW5jdGlvbiBjYWxsZWQgd2l0aCBhbnkgZXJyb3IgdGhhdCBvY2N1cnJlZC5cbiAqXG4gKiBAcHJpdmF0ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZGVsZXRlRG5zUmVjb3JkKGF1dGg6IEF1dGgsIHJlY29yZE5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgem9uZU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IChlcnI/OiBFcnJvcikgPT4gdm9pZCk6IHZvaWRcbntcbiAgICBnZXRab25lSWQoem9uZU5hbWUsIGF1dGgsIChlcnJvciwgem9uZUlkKSA9PiB7XG4gICAgICAgIGlmIChlcnJvciB8fCAhem9uZUlkKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhlcnJvciB8fCBuZXcgRXJyb3IoXCJVbmtub3duIGVycm9yXCIpKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBnZXREbnNSZWNvcmRJZCh6b25lSWQsIHJlY29yZE5hbWUsIGF1dGgsIChlcnJvcjIsIGRuc1JlY29yZElkKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyb3IyKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyb3IyKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkbnNSZWNvcmRJZCkge1xuICAgICAgICAgICAgICAgIGdldFJlc3VsdHMoYHpvbmVzLyR7em9uZUlkfS9kbnNfcmVjb3Jkcy8ke2Ruc1JlY29yZElkfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVycm9yMywgcmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjMgfHwgIXJlc3VsdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjMgfHwgbmV3IEVycm9yKFwiVW5rbm93biBlcnJvclwiKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBcIkRFTEVURVwiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIEROUyByZWNvcmQgd2l0aCB0aGUgc3BlY2lmaWVkIGluZm9ybWF0aW9uLlxuICpcbiAqIEBwYXJhbSB6b25lSWQgVGhlIHpvbmUgSUQuXG4gKiBAcGFyYW0gZG5zUmVjb3JkTmFtZSBUaGUgRE5TIHJlY29yZCBuYW1lLlxuICogQHBhcmFtIGlwIFRoZSBJUCB0byB1cGRhdGUgdGhlIHJlY29yZCB3aXRoLlxuICogQHBhcmFtIGF1dGggQ2xvdWRGbGFyZSBBUEkgYXV0aGVudGljYXRpb24gaW5mb3JtYXRpb24uXG4gKiBAcGFyYW0gY2FsbGJhY2sgQ2FsbGJhY2sgZnVuY3Rpb24gY2FsbGVkIHdpdGggYW55IGVycm9yIHRoYXQgb2NjdXJyZWQuXG4gKlxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gY3JlYXRlRG5zUmVjb3JkKHpvbmVJZDogc3RyaW5nLCBkbnNSZWNvcmROYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgaXA6IHN0cmluZywgYXV0aDogQXV0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogKGVycm9yPzogRXJyb3IpID0+IHZvaWQpXG57XG4gICAgZ2V0UmVzdWx0cyhgem9uZXMvJHt6b25lSWR9L2Ruc19yZWNvcmRzYCxcbiAgICAgICAgICAgICAgIGF1dGgsXG4gICAgICAgICAgICAgICAoZXJyb3IsIHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IgfHwgIXJlc3VsdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyb3IgfHwgbmV3IEVycm9yKFwiVW5rbm93biBlcnJvclwiKSk7XG4gICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICBcIlBPU1RcIixcbiAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBpcCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBkbnNSZWNvcmROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiQVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG59XG5cbi8qKlxuICogVXBkYXRlcyBhIEROUyByZWNvcmQgd2l0aCB0aGUgc3BlY2lmaWVkIGluZm9ybWF0aW9uLlxuICpcbiAqIEBwYXJhbSB6b25lSWQgVGhlIHpvbmUgSUQuXG4gKiBAcGFyYW0gcmVjb3JkSWQgVGhlIEROUyByZWNvcmQgSUQuXG4gKiBAcGFyYW0gaXAgVGhlIElQIHRvIHVwZGF0ZSB0aGUgcmVjb3JkIHdpdGguXG4gKiBAcGFyYW0gYXV0aCBDbG91ZEZsYXJlIEFQSSBhdXRoZW50aWNhdGlvbiBpbmZvcm1hdGlvbi5cbiAqIEBwYXJhbSBjYWxsYmFjayBDYWxsYmFjayBmdW5jdGlvbiBjYWxsZWQgd2l0aCBhbnkgZXJyb3IgdGhhdCBvY2N1cnJlZC5cbiAqXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiB1cGRhdGVEbnNSZWNvcmQoem9uZUlkOiBzdHJpbmcsIHJlY29yZElkOiBzdHJpbmcsIGlwOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgYXV0aDogQXV0aCwgY2FsbGJhY2s6IChlcnJvcj86IEVycm9yKSA9PiB2b2lkKVxue1xuICAgIGdldFJlc3VsdHMoYHpvbmVzLyR7em9uZUlkfS9kbnNfcmVjb3Jkcy8ke3JlY29yZElkfWAsXG4gICAgICAgICAgICAgICBhdXRoLFxuICAgICAgICAgICAgICAgKGVycm9yLCByZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgaWYgKGVycm9yIHx8ICFyZXN1bHRzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yIHx8IG5ldyBFcnJvcihcIlVua25vd24gZXJyb3JcIikpO1xuICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgXCJQQVRDSFwiLFxuICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGlwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiQVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG59XG5cbi8qKlxuICogR2V0cyB0aGUgRE5TIHJlY29yZCBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIHNwZWNpZmllZCByZWNvcmQgbmFtZS5cbiAqXG4gKiBAcGFyYW0gem9uZUlkIFRoZSB6b25lIElELlxuICogQHBhcmFtIGRuc1JlY29yZE5hbWUgVGhlIEROUyByZWNvcmQgbmFtZS5cbiAqIEBwYXJhbSBhdXRoIENsb3VkRmxhcmUgQVBJIGF1dGhlbnRpY2F0aW9uIGluZm9ybWF0aW9uLlxuICogQHBhcmFtIGNhbGxiYWNrIENhbGxiYWNrIGZ1bmN0aW9uIGNhbGxlZCB3aXRoIGFueSBlcnJvciB0aGF0IG9jY3VycmVkLCBhc1xuICogICAgICAgICAgICAgICAgIHdlbGwgYXMgdGhlIEROUyByZWNvcmQgSUQuXG4gKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldERuc1JlY29yZElkKHpvbmVJZDogc3RyaW5nLCBkbnNSZWNvcmROYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0aDogQXV0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogKGVycm9yPzogRXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbnNSZWNvcmRJZD86IHN0cmluZykgPT4gdm9pZCk6IHZvaWRcbntcbiAgICBnZXRSZXN1bHRzKGB6b25lcy8ke3pvbmVJZH0vZG5zX3JlY29yZHNgLCBhdXRoLCAoZXJyb3IsIHJlc3VsdHMpID0+IHtcbiAgICAgICAgaWYgKGVycm9yIHx8ICFyZXN1bHRzKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhlcnJvciB8fCBuZXcgRXJyb3IoXCJVbmtub3duIGVycm9yXCIpKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1hdGNoaW5nUmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKFxuICAgICAgICAgICAgcmVzdWx0ID0+IHJlc3VsdC5uYW1lID09PSBkbnNSZWNvcmROYW1lKTtcbiAgICAgICAgaWYgKG1hdGNoaW5nUmVzdWx0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1hdGNoaW5nUmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhuZXcgQXBpRXJyb3Ioe1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBNdWx0aXBsZSBETlMgcmVjb3JkIGVudHJpZXMgZm91bmQgd2l0aCBuYW1lYFxuICAgICAgICAgICAgICAgICAgICAgICAgICsgYCAke2Ruc1JlY29yZE5hbWV9YCxcbiAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdHNcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG1hdGNoaW5nUmVzdWx0c1swXTtcbiAgICAgICAgaWYgKCFpc1N0cmluZyhyZXN1bHQuaWQpKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhuZXcgQXBpRXJyb3Ioe1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiSUQgZm9yIEROUyByZWNvcmQgZW50cnkgbWFsZm9ybWVkIG9yIG1pc3NpbmdcIixcbiAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdHNcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgcmVzdWx0LmlkKTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBHZXRzIHRoZSB6b25lIElEIGFzc29jaWF0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIHpvbmUgbmFtZS5cbiAqXG4gKiBAcGFyYW0gem9uZU5hbWUgVGhlIHpvbmUgbmFtZS5cbiAqIEBwYXJhbSBhdXRoIENsb3VkRmxhcmUgQVBJIGF1dGhlbnRpY2F0aW9uIGluZm9ybWF0aW9uLlxuICogQHBhcmFtIGNhbGxiYWNrIENhbGxiYWNrIGZ1bmN0aW9uIGNhbGxlZCB3aXRoIGFueSBlcnJvciB0aGF0IG9jY3VycmVkLCBhc1xuICogICAgICAgICAgICAgICAgIHdlbGwgYXMgdGhlIHpvbmUgSUQuXG4gKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFpvbmVJZCh6b25lTmFtZTogc3RyaW5nLCBhdXRoOiBBdXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogKGVycm9yPzogRXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ/OiBzdHJpbmcpID0+IHZvaWQpOiB2b2lkXG57XG4gICAgZ2V0UmVzdWx0cyhcInpvbmVzXCIsIGF1dGgsIChlcnJvciwgcmVzdWx0cykgPT4ge1xuICAgICAgICBpZiAoZXJyb3IgfHwgIXJlc3VsdHMpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yIHx8IG5ldyBFcnJvcihcIlVua25vd24gZXJyb3JcIikpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbWF0Y2hpbmdSZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoXG4gICAgICAgICAgICByZXN1bHQgPT4gcmVzdWx0Lm5hbWUgPT09IHpvbmVOYW1lKTtcbiAgICAgICAgaWYgKG1hdGNoaW5nUmVzdWx0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBBcGlFcnJvcih7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYE5vIHpvbmUgZW50cmllcyBmb3VuZCB3aXRoIG5hbWUgJHt6b25lTmFtZX1gLFxuICAgICAgICAgICAgICAgIHJlc3VsdDogcmVzdWx0c1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXRjaGluZ1Jlc3VsdHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgY2FsbGJhY2sobmV3IEFwaUVycm9yKHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBgTm8gem9uZSBlbnRyaWVzIGZvdW5kIHdpdGggbmFtZSAke3pvbmVOYW1lfWAsXG4gICAgICAgICAgICAgICAgcmVzdWx0OiByZXN1bHRzXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSByZXN1bHRzWzBdO1xuICAgICAgICBpZiAoIWlzU3RyaW5nKHJlc3VsdC5pZCkpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBBcGlFcnJvcih7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogXCJJRCBmb3Igem9uZSBlbnRyeSBtYWxmb3JtZWQgb3IgbWlzc2luZ1wiLFxuICAgICAgICAgICAgICAgIHJlc3VsdDogcmVzdWx0c1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCByZXN1bHQuaWQpO1xuICAgIH0pO1xufVxuXG4vKipcbiAqIEdldHMgcmVzdWx0cyBmcm9tIHRoZSBDbG91ZEZsYXJlIEFQSS5cbiAqXG4gKiBAcGFyYW0gcGF0aCBUaGUgVVJJLlxuICogQHBhcmFtIGF1dGggQ2xvdWRGbGFyZSBBUEkgYXV0aGVudGljYXRpb24gaW5mb3JtYXRpb24uXG4gKiBAcGFyYW0gY2FsbGJhY2sgQ2FsbGJhY2sgZnVuY3Rpb24gY2FsbGVkIHdpdGggYW55IGVycm9yIHRoYXQgb2NjdXJyZWQsIGFzXG4gKiAgICAgICAgICAgICAgICAgd2VsbCBhcyB0aGUgQVBJIHJlc3VsdHMuXG4gKiBAcGFyYW0gbWV0aG9kIFRoZSBIVFRQIG1ldGhvZC5cbiAqIEBwYXJhbSBib2R5IFRoZSByZXF1ZXN0IGJvZHkuXG4gKiBAcGFyYW0gc3RhcnRQYWdlIFRoZSBzdGFydCBwYWdlIGFzc29jaWF0ZWQgd2l0aCB0aGUgcmVxdWVzdC5cbiAqXG4gKiBAcHJpdmF0ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVzdWx0cyhwYXRoOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRoOiBBdXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IChlcnJvcj86IEVycm9yLCByZXN1bHRzPzogYW55W10pID0+IHZvaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IHN0cmluZyA9IFwiR0VUXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5Pzogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRQYWdlOiBudW1iZXIgPSAxKTogdm9pZFxue1xuICAgIGxldCB1cmkgPSBgJHtCQVNFX1VSTH0vJHtwYXRofWA7XG4gICAgaWYgKG1ldGhvZCA9PT0gXCJHRVRcIikge1xuICAgICAgICB1cmkgKz0gYD9wYWdlPSR7c3RhcnRQYWdlfWA7XG4gICAgfVxuICAgIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgICAgIFwiWC1BdXRoLUtleVwiOiBhdXRoLmtleSxcbiAgICAgICAgXCJYLUF1dGgtRW1haWxcIjogYXV0aC5lbWFpbFxuICAgIH07XG4gICAgaHR0cHNSZXF1ZXN0KHVyaSwgKGVycm9yLCByZXNwb25zZSwgcmVzcG9uc2VCb2R5KSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgY2FsbGJhY2sobmV3IEFwaUVycm9yKHtcbiAgICAgICAgICAgICAgICBib2R5OiByZXNwb25zZUJvZHksXG4gICAgICAgICAgICAgICAgaW5uZXJFcnJvcjogZXJyb3IsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogXCJFcnJvciBhY2Nlc3NpbmcgQ2xvdWRGbGFyZSBBUElcIixcbiAgICAgICAgICAgICAgICByZXNwb25zZVxuICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFyZXNwb25zZUJvZHkpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBBcGlFcnJvcih7XG4gICAgICAgICAgICAgICAgaW5uZXJFcnJvcjogZXJyb3IsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogXCJNaXNzaW5nIHJlc3BvbnNlIGJvZHlcIixcbiAgICAgICAgICAgICAgICByZXNwb25zZVxuICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VCb2R5KTtcbiAgICAgICAgaWYgKCFqc29uLnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBBcGlFcnJvcih7XG4gICAgICAgICAgICAgICAgYm9keTogcmVzcG9uc2VCb2R5LFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiQ2xvdWRGbGFyZSBBUEkgcmV0dXJuZWQgc3VjY2VzcyBmYWxzZVwiLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVzdWx0czogYW55W10gPSBbXTtcbiAgICAgICAgaWYgKGlzQXJyYXkoanNvbi5yZXN1bHQpKSB7XG4gICAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQoanNvbi5yZXN1bHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGpzb24ucmVzdWx0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChqc29uLnJlc3VsdF9pbmZvXG4gICAgICAgICAgICAmJiBqc29uLnJlc3VsdF9pbmZvLnBhZ2VcbiAgICAgICAgICAgICAgIDwganNvbi5yZXN1bHRfaW5mby50b3RhbF9wYWdlcylcbiAgICAgICAge1xuICAgICAgICAgICAgZ2V0UmVzdWx0cyhwYXRoLCBhdXRoLCAoZXh0cmFFcnJvciwgZXh0cmFSZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGV4dHJhRXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuY29uY2F0KGV4dHJhUmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCByZXN1bHRzKTtcbiAgICAgICAgICAgIH0sIG1ldGhvZCwgYm9keSwgc3RhcnRQYWdlICsgMSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHJlc3VsdHMpO1xuICAgICAgICB9XG4gICAgfSwgbWV0aG9kLCBoZWFkZXJzLCBib2R5KTtcbn1cbiJdfQ==
